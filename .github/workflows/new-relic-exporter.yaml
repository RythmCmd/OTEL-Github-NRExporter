name: Change Tracking Marker
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  newrelic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Resolve New Relic Entity GUID by Tag
        id: resolve
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}
          REPO:                ${{ github.repository }}
        run: |
          # Build GraphQL payload to find the entity tagged "repo=<org>/<repo>"
          PAYLOAD="{\"query\":\"{ actor { entitySearch(queryBuilder: {tags: {value: \\\"${REPO}\\\", key: \\\"repo\\\"}}) { results { entities { guid } } } } }\"}"
          # Call NerdGraph and extract the GUID
          GUID=$(curl -s -X POST https://api.newrelic.com/graphql \
            -H "Content-Type: application/json" \
            -H "API-Key: $NEW_RELIC_API_KEY" \
            -d "$PAYLOAD" \
          | jq -r '.data.actor.entitySearch.results.entities[0].guid')
          echo "ENTITY_GUID=$GUID" >> $GITHUB_ENV

      - name: Set Release Version
        run: |
          echo "RELEASE_VERSION=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: New Relic Deployment Marker
        uses: newrelic/deployment-marker-action@v2
        with:
          apiKey:        ${{ secrets.NEW_RELIC_API_KEY }}
          region:        US                   # or "EU"
          guid:          ${{ env.ENTITY_GUID }}
          version:       ${{ env.RELEASE_VERSION }}
          commit:        ${{ github.sha }}
          changelog:     "https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md"
          description:   "Automated Release via GitHub Actions"
          deploymenttype: ROLLING
          groupId:       "Release: ${{ github.ref_name }}"
          user:          ${{ github.actor }}
